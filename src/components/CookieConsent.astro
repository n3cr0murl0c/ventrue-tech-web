---
interface Props {
  lang?: string;
}

const { lang = 'es' } = Astro.props;

const translations = {
  es: {
    title: 'üç™ Preferencias de Privacidad',
    description: 'Utilizamos cookies y tecnolog√≠as similares para mejorar tu experiencia, analizar el tr√°fico del sitio y mostrar contenido relevante.',
    accept: 'Aceptar',
    reject: 'Rechazar',
    customize: 'Personalizar',
    acceptAll: 'Aceptar todo',
    necessary: 'Necesarias',
    analytics: 'Anal√≠ticas',
    marketing: 'Marketing',
    save: 'Guardar preferencias',
    close: 'Cerrar',
    settings: 'Configuraci√≥n',
    privacyLink: 'Pol√≠tica de Privacidad',
  },
  en: {
    title: 'üç™ Privacy Preferences',
    description: 'We use cookies and similar technologies to improve your experience, analyze site traffic, and show relevant content.',
    accept: 'Accept',
    reject: 'Reject',
    customize: 'Customize',
    acceptAll: 'Accept all',
    necessary: 'Necessary',
    analytics: 'Analytics',
    marketing: 'Marketing',
    save: 'Save preferences',
    close: 'Close',
    settings: 'Settings',
    privacyLink: 'Privacy Policy',
  }
};

const t = translations[lang as keyof typeof translations] || translations.es;
---

<!-- Cookie Consent Banner -->
<div id="cookie-consent" class="fixed bottom-0 left-0 right-0 z-50 hidden">
  <div class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 shadow-2xl">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
        <div class="flex-1">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-1">{t.title}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">{t.description}</p>
          <a href={`/${lang}/privacy`} class="text-xs text-primary-500 hover:underline mt-1 inline-block">
            {t.privacyLink}
          </a>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="cookie-reject" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            {t.reject}
          </button>
          <button id="cookie-settings" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            {t.settings}
          </button>
          <button id="cookie-accept" class="px-4 py-2 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 rounded-lg transition-colors">
            {t.acceptAll}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Customization Panel -->
<div id="cookie-customize" class="fixed inset-0 z-50 hidden">
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="cookie-customize-overlay"></div>
  <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 rounded-t-2xl shadow-2xl max-h-[80vh] overflow-y-auto">
    <div class="max-w-xl mx-auto px-6 py-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{t.customize}</h3>
        <button id="cookie-customize-close" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <!-- Necessary Cookies (Always Required) -->
      <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
        <div>
          <p class="font-medium text-gray-900 dark:text-white">{t.necessary}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">Required for the site to function properly</p>
        </div>
        <input type="checkbox" checked disabled class="w-5 h-5 text-primary-500 rounded cursor-not-allowed" />
      </div>
      
      <!-- Analytics Cookies -->
      <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
        <div>
          <p class="font-medium text-gray-900 dark:text-white">{t.analytics}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">Help us understand how visitors use our site</p>
        </div>
        <input type="checkbox" id="cookie-analytics" class="w-5 h-5 text-primary-500 rounded cursor-pointer" />
      </div>
      
      <!-- Marketing Cookies -->
      <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
        <div>
          <p class="font-medium text-gray-900 dark:text-white">{t.marketing}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">Personalized advertisements and content</p>
        </div>
        <input type="checkbox" id="cookie-marketing" class="w-5 h-5 text-primary-500 rounded cursor-pointer" />
      </div>
      
      <div class="mt-6 flex justify-end gap-2">
        <button id="cookie-save" class="px-6 py-2 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 rounded-lg transition-colors">
          {t.save}
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function() {
    const cookieConsent = document.getElementById('cookie-consent');
    const cookieCustomize = document.getElementById('cookie-customize');
    
    // Check if user has already consented
    const hasConsent = localStorage.getItem('ventrue_consent');
    
    if (!hasConsent) {
      // Show consent banner after delay
      setTimeout(() => {
        cookieConsent.classList.remove('hidden');
      }, 2000);
    } else {
      // Apply saved consent if window.VentrueConsent exists
      if (typeof window.VentrueConsent !== 'undefined') {
        window.VentrueConsent.init();
      }
    }
    
    // Accept All
    document.getElementById('cookie-accept')?.addEventListener('click', () => {
      if (typeof window.VentrueConsent !== 'undefined') {
        window.VentrueConsent.acceptAll();
      } else {
        gtag('consent', 'update', {
          analytics_storage: 'granted',
          ad_storage: 'granted',
          ad_user_data: 'granted',
          ad_personalization: 'granted'
        });
      }
      cookieConsent.classList.add('hidden');
    });
    
    // Reject All
    document.getElementById('cookie-reject')?.addEventListener('click', () => {
      if (typeof window.VentrueConsent !== 'undefined') {
        window.VentrueConsent.rejectAll();
      } else {
        gtag('consent', 'update', {
          analytics_storage: 'denied',
          ad_storage: 'denied',
          ad_user_data: 'denied',
          ad_personalization: 'denied'
        });
      }
      cookieConsent.classList.add('hidden');
    });
    
    // Open Settings
    document.getElementById('cookie-settings')?.addEventListener('click', () => {
      // Load current preferences if they exist
      const saved = localStorage.getItem('ventrue_consent');
      if (saved) {
        const prefs = JSON.parse(saved);
        const analyticsCheckbox = document.getElementById('cookie-analytics');
        const marketingCheckbox = document.getElementById('cookie-marketing');
        if (analyticsCheckbox) analyticsCheckbox.checked = prefs.analytics;
        if (marketingCheckbox) marketingCheckbox.checked = prefs.ads || prefs.marketing;
      }
      cookieCustomize.classList.remove('hidden');
    });
    
    // Close Settings Overlay
    document.getElementById('cookie-customize-overlay')?.addEventListener('click', () => {
      cookieCustomize.classList.add('hidden');
    });
    
    document.getElementById('cookie-customize-close')?.addEventListener('click', () => {
      cookieCustomize.classList.add('hidden');
    });
    
    // Save Custom Preferences
    document.getElementById('cookie-save')?.addEventListener('click', () => {
      const analyticsEl = document.getElementById('cookie-analytics');
      const marketingEl = document.getElementById('cookie-marketing');
      
      const analyticsGranted = analyticsEl ? analyticsEl.checked : false;
      const marketingGranted = marketingEl ? marketingEl.checked : false;
      
      // Save to localStorage
      localStorage.setItem('ventrue_consent', JSON.stringify({
        analytics: analyticsGranted,
        ads: marketingGranted,
        personalization: marketingGranted,
        timestamp: new Date().toISOString()
      }));
      
      // Update GA consent
      gtag('consent', 'update', {
        analytics_storage: analyticsGranted ? 'granted' : 'denied',
        ad_storage: marketingGranted ? 'granted' : 'denied',
        ad_user_data: marketingGranted ? 'granted' : 'denied',
        ad_personalization: marketingGranted ? 'granted' : 'denied'
      });
      
      cookieCustomize.classList.add('hidden');
      cookieConsent.classList.add('hidden');
    });
  })();
</script>
